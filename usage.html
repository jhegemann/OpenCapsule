<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" >
<html>
	<head>
		<meta charset="utf-8">
		<title>OpenCapsule - documentation</title>
		<style>
                                body {
                                        padding-top: 50px;
                                        width: 50%;
                                        margin: 0 auto;
                                        font-size: 14;
                                }
                                headline {
                                        
                                        font-family: Georgia;
                                        font-size: 48px;
                                        font-style: bold;
                                        font-variant: small-caps;
                                        font-weight: 500;
                                        color: #104e8b;
                                        line-height: 26.4px;
                                }
                                h1 {
                                        font-family: Georgia;
                                        font-size: 24px;
                                        font-style: normal;
                                        font-variant: normal;
                                        font-weight: 500;
                                        line-height: 26.4px;
                                }
                                h2 {
                                        font-family: Georgia;
                                        font-size: 20px;
                                        font-style: italic;
                                        font-variant: normal;
                                        font-weight: 500;
                                        line-height: 15.4px;
                                }
                                p {
                                        font-family: Georgia;
                                        font-size: 15px;
                                        font-style: normal;
                                        font-variant: normal;
                                        font-weight: 400;
                                        line-height: 20px;
                                        text-align: justify
                                }
                                c {
                                        font-family: Georgia;
                                        font-size: 15px;
                                        font-style: italic;
                                        font-variant: normal;
                                        font-weight: 400;
                                        line-height: 20px;
                                        text-align: justify
                                }
                                b {
                                        font-family: Georgia;
                                        font-size: 15px;
                                        font-style: italic;
                                        font-variant: normal;
                                        font-weight: bold;
                                        line-height: 20px;
                                        text-align: justify
                                }
		</style>
	</head>
<body>

<h1>OpenCapsule - Pendant Capsule Elastometry</h1>
  
<p>C/C++ Software / Command Line Interface / Linux</p>
<p>Developed at TU Dortmund University</p>
<p><c>Author</c>: Jonas Hegemann, (jonas.hegemann@tu-dortmund.de)</p>
<p><c>Framework</c>: Sebastian Knoche (sebastian.knoche@tu-dortmund.de)</p>
<p><c>Supervisor</c>: Jan Kierfeld (jan.kierfeld@tu-dortmund.de)</p>

<p><c>Description</c>:<br>
  We provide a
  <a href="www.github.com/jhegemann/opencapsule">C/C++ software</a>
  for the shape analysis of deflated elastic capsules in a
pendant capsule geometry, which is based on the proper elastic description of
the capsule material as a quasi two-dimensional elastic layer using shell theory. 
This pendant capsule elastometry provides a new tool
for interfacial rheology of capsules that goes beyond 
determination of the  Gibbs- or dilatational modulus from 
area-dependent  measurements of the surface tension using 
pendant drop tensiometry,
which can only give a rough estimate of the elastic capsule properties as they
are based on a purely liquid interface model.
The software allows to determine
the following quantities for each digitized image of a 
deflated capsule shape given 
another image of its undeformed reference shape: 
the surface tension characterizing the reference shape, Young's
surface modulus (or alternatively area compression modulus) 
and  Poisson's ratio.
If series of images are available,
these moduli can be determined as a function of the capsule volume
to analyze viscoelastic effects for different volume change rates
and aging effects depending on the deformation history. 
An additional wrinkling wavelength measurement allows 
to determine the  bending modulus, from which 
the layer thickness can be derived. 
We verified the method by analyzing several materials and comparing
the results to available rheological measurements.
We make the software available under the GPL license.
<p>

<p>Collaboration partners: <br>Patrick Degen, Sarah Demand, Simon Egger, Maureen Kott, Anja Unverfehrt, and Heinz Rehage from the Department of Chemistry at the TU Dortmund. <br> 
Sandrine Le Tirilly and C&eacutecile Monteux from &Eacutecole Sup&eacuterieure de Physique et de Chimie Industrielles de la Ville de Paris (ESPCI).<br>
Andrew Salmon and Chris Abell from the Department of Chemistry at the University of Cambridge</p>

<p><c>Publications</c>:<br><br>
  Pendant capsule elastometry<br>
  J. Hegemann, S. Knoche, S. Egger, H. Rehage, and J. Kierfeld <br>
  Journal of Colloid and Interface Science, ... to be published <br><br>

  Elastometry of deflated capsules: Elastic moduli from shape and wrinkle analysis<br>
  S. Knoche, D. Vella, E. Aumaitre, P. Degen, H. Rehage, P. Cicuta, and J. Kierfeld <br>
  Langmuir, Vol. 29, No. 40, Pages 12463--12471, 2013, ACS Publications</p>

<p><c>Support</c>:<br>
  If you have issues using OpenCapsule, 
  please let us know and send a mail to jonas.hegemann@tu-dortmund.de. 
  We are encouraged to help as far as possible. 
  If you encounter bugs or develop improvements, let us know, too.
  If you use OpenCapsule in your research department
  or company, please cite the software and the papers above. <br><br>

<!--Bibtex: <br>

@misc{opencapsule2017, <div style="text-indent:25px;">author = {Hegemann, J and Kierfeld, J},</div>
<div style="text-indent:25px;">title = {OpenCapsule - GPLv3},</div>
<div style="text-indent:25px;">version = {1.0},</div>
<div style="text-indent:25px;">organization = {TU Dortmund},</div>
<div style="text-indent:25px;">url = {http://www.github.com/jhegemann/opencapsule},</div>
<div style="text-indent:25px;">pagination = {section},</div>
<div style="text-indent:25px;">language = {english},</div>
<div style="text-indent:25px;">date = {2007-06-29}</div><br>
} 
</p>-->



<h1>Source Files</h1>

<p>The following source files are included in the <a href="www.github.com/jhegemann/opencapsule">repository</a>:</p>

<ul>
<li><p><b>main.cpp</b>: parses the command line and forwards operations to interface.cpp</p></li>
<li><p><b>config.cpp config.h</b>: parses the configuration file and keeps values accessible during runtime</p></li>
<li><p><b>interface.cpp interface.h</b>: implements high level regression operations in human readable form</p></li>
<li><p><b>image.cpp image.h</b>: implements image processing including edge detection and contour extraction</p></li>
<li><p><b>capsule.cpp capsule.h</b>: implements numerical procedures for integration and regression of shape equations</p></li>
<li><p><b>objects.cpp objects.h</b>: defines several classes/containers wrapping the raw data</p></li>
<li><p><b>script.cpp script.h</b>: automatic creation of gnuplot scripts (optional usage)</p></li>
</ul>


<h1>Installation Guide</h1>

<p>OpenCapsule was tested (successful compiling and running) on Ubuntu 16.04 LTS and Scientific Linux 6.6 
with GNU/GCC compiler. To install OpenCapsule first download the tarball and extract it to some arbitrary 
  direction or simply clone the
<a href="www.github.com/jhegemann/opencapsule">repository</a>.
  Before compiling install the required dependencies</p>

		<b>Boost, OpenCV, Gnu Scientific Library (GSL)</b>

<p>e.g. on Ubuntu typing something like</p>

		<b>sudo apt-get install gcc g++ make libboost-all-dev libopencv-dev libgsl0-dev libgsl0ldbl</b>

<p>in a login-shell will be sufficient. On Scientific Linux, i.e. Fedora system, use Yum package manager or 
install the libraries manually. OpenCapsule uses OpenCV for image handling and therefore 
only supports the image formats supported by your specific installation.
Check if all PATH variables are set appropriately or adapt the Makefile by informing g++ explicitly 
where to find the libraries by using the -L option. Finally, simply type</p>

		<b>make</b>

<p>to compile the project. If you like to set up a more usable working environment also type</p>

		<b>sudo make install</b>

<p>to make OpenCapsule accessible in all working directories.</p>

<h1>Image requirements</h1>

<p>To ensure images are compatible with OpenCapsule and can be analyzed correctly, they have to
meet several requirements, which are given in the following. </p>

<ul>
<li><p>The needle should be visible in the upper part of the image.</p></li>
<li><p>As far as possible, the capsule should to be aligned along the vertical axis.</p></li>
<li><p>Gravitational forces should act along the vertical axis.</p></li>
<li><p>The background should be equally colored with no other objects or artefacts in there troubling contour detection.</p></li>
<li><p>The camera should not be moved during recording of the sequence.</p></li>
<li><p>Inner and outer capillary diameter should differ significantly.</p></li>
</ul>

<h1>Getting Started</h1>

<p> To give an impression of the typical command line workflow some examples are given in the following.
A typical task would be to perform a Laplace-Young analysis, which is nowadays the standard algorithm for
analyzing droplets and capsules. Based on this, OpenCapsule provides 
an additional algorithm based on Hookean elasticity, which is capable to describe shapes of elastic shells
more accurately than the Laplace-Young analysis.
This model exhibits much more information,
such as the elastic moduli, stress distributions and details about the wrinkling. 
OpenCapsule differs from other implementations by a high degree of automation and numerical robustness. <br><br>

Change to your prefered working directory and call OpenCapsule by simply typing</p>

		<b>OpenCapsule</b>

<p>in the shell. If your working environment is set up correctly, OpenCapsule gives you some general information
about itself. Additionally, all necessary directories and a standard configuration file are created.
Please edit the configuration file "config/config.cfg" before you proceed. 
List your input files, which should placed (by default) in the "input" folder just created,  
under REFERENCE_SHAPE and ELASTIC_SHAPE. 
OpenCapsule averages over reference images, which should all show the same, undeformed state of the capsule.
Make sure you have specified the fields
EXPERIMENT_CAPDIAMETER and EXPERIMENT_DENSITY in SI units. If you are not sure how to handle the 
configuration file, see the corresponding section for more details about this.
Next, typing</p>

		<b>OpenCapsule -h</b>

<p>will give you an overview over the command line options as well as a list of common examples.
The results of the following standard commands are placed in the "global_out" folder, where you
will find the results listed in plain *.txt files, images in *.png format, and wrapped in a 
comprehensive html-report. </p>

<h2>Edge Detection</h2>

		<b>OpenCapsule -i [path to image]</b>

<p>This command performs an isolated image analysis of the image specified by the option --image. 
If your image processing fails or results are obviously bad, you can adapt OpenCapsule to your specific images. 
Try to tune the related values in the configuration file to get an optimal result.
If everything works fine, perform the shape analysis. </p>

<h2>1) Laplace-Young analysis </h2>

                 <b>OpenCapsule -r</b>

<p>This command triggers the standard Laplace-Young analysis. No initial values have to
be specified. </p>

<h2>2) Elastic shape analysis</h2>

		<b>OpenCapsule -s</b>

<p>This command triggers the elastic shape analysis and will automatically use the specified
reference shapes. You can also provide initial values by using the call</p>

		<b>OpenCapsule -s --poisson 0.5 --compression 10.0 --pressure 1.0</b>

<p>These three parameters are <c>optional</c>. The first one specifies
an initial guess of Poisson's ratio. The second one specifies an initial guess of the area
compression modulus in units of the surface tension obtained by the reference regression.
The third one specifies an initial guess for the dimensionless pressure at the apex of the deflated capsule in 
units of the surface tension and the inverse capillary diameter. Only if the simple call
without initial values
gives no adequate result, you should provide intitial values for the fit parameters. </p>

<h1>Generated Output</h1>

<p> The essential results are saved to the GLOBAL_OUT_FOLDER. Most interesting are the summarized
results written to the files "reference.dat" and "sequence.dat". Moreover a lot of miscellaneous output
is generated including the determined shapes, extracted contours, binary images and general image information,
i.e. quantities measured from the binary image.
The most instructive output is the input image with the determined shape and wrinkle domain overlayed.
From these images you can immediately judge if the analysis was successful. 
With GNUPLOT_SUPPORT activated you also get all relevant plots as *.eps files.
Don't worry about the large number of output files. They are named intuitively and self explanatory. 
The file "report.html" merges a lot of information into a single file, including all determined values
in SI units and images with shapes overlayed.</p>

<h1>License</h1>

<p>
OpenCapsule is GPLv3 licensed and thereby 100% Open Source Software. Feel free to use it in-house in your research
department or company. Feel free to improve or adapt OpenCapsule,
but notice that the resulting code has to be GPLv3 licensed, too. 
You are NOT allowed to include the OpenCapsule code or a derivate
in proprietary or closed source applications. You are also NOT allowed to compile OpenCapsule into
a library and link against this library. However, it is legitimate to access the OpenCapsule binary
(as a black box) from your proprietary software. For details see the original 
<a href="http://www.gnu.org/licenses/gpl.html">GPLv3 license</a>.
</p>

<h1>Frequent Issues</h1>

<h2>OpenCapsule does not detect a closed contour...</h2>

    <p>Most probably it helps to increase the variable GAUSSIAN_SIGMA in 1.0 steps to smooth the image.
    Edge detection strongly depends on the contrast and brightness of your image. Sometimes it helps to adjust
    the thresholds T_LOW and T_HIGH for the hysteresis alogrithm performed as the last step of edge detection.
    Try some other (probably higher) values most preferable at ratios T_HIGH/T_LOW = 3:1, 2:1 or something similar.
    You can switch off the option CHECK_IF_CLOSED, but this is not recommended. 
    Note that both thresholds are in the range between zero and one. Very small values
    force the edge detection to be very sensitive whereas values close to one will find only very few contour points.</p>

<h2>Some of the numerical algorithms don't converge...</h2>

    <p>First, turn on the corresponding WATCH_XXX variable to get an impression of what happens. Then, carefully tune
    the corresponding numerical thresholds, e.g. lower the required accuracies EPS_XXX. Also think about tuning your
    initial values and make sure NELDERMEAD_PREFITTING is enabled.</p>

<h2>OpenCapsule simply aborts before doing anything...</h2>

    <p>This is probably an issue of your selected paths or input files. Make sure all filenames are valid and backed by
    a real file. Check if your configuration file contains all necessary values. Consider a rollback to the standard
    configuration file.</p>

<h1>Upcoming Changes</h1>
<p>
In addition to hookean elasticity, we plan to implement more elastic material laws, such as Mooney-Rivlin elasticity.
This could help to decide which material law fits best for a specific capsule type. We also aim to implement extensions
in order to include viscoelastic effects. Having analyzed plenty of materials in the future, it would be useful to have
a large database collecting all the different materials/capsules similar to already existing 
protein- or gen-databases. This would help to classify materials based on their elastic properties.
</p>

<h1>Configuration File</h1>

<p>All settings are controlled by the configuration file ./config/config.cfg 
relative to the current working directory. Settings can be 
divided in several major classes, which are explained in the following.
NOTE: only the sections 1)+2) and maybe 4)+5) are important for the average user.
These sections are marked as "user-space". Sections, which must not be left unspecified are
marked as "mandatory". Values given behind the properties are standard values. Reasonable ranges
are given in bracktes.<p>

<h2>1) Input files (user-space, mandatory)</h2>

		<p>Put the file names of your input images in a list seperated by colons. 
		For the undeformed reference shapes give as many (similar) 
		images as possible, because OpenCapsule will average over all these images. 
		No specific ordering is required for the reference shapes.
		For the deformed (deflated) shapes make sure they are ordered chronologically,
		such that parameters can be traced and convergence will be more stable and faster. If some deflated shapes
		are very close or similar to the reference shape, please discard them.</p>

	<b>REFERENCE_SHAPE reference1.png;reference2.png</b>
		<p>unordered list of files (in input-folder) for reference images separated by colons</p>

	<b>ELASTIC_SHAPE elastic1.png;elastic2.png;elastic3.png;elastic4.png</b>
		<p>(chronlogically ordered) list of files (in input-folder) for elastic images separated by colons</p>

<h2>2) Experimental quantities (user-space, mandatory)</h2>

		<p>OpenCapsule won't run or give any result if you don't give the outer capillary diameter in m
		and the density difference between inner and outer phase in kg/m^3.</p>

	<b>EXPERIMENT_DENSITY (100.0 .. 900.0)</b>
		<p>density difference between inner and outer phase in kg/m^3</p>

	<b>EXPERIMENT_CAPDIAMETER (0.0005 .. 0.002)</b>
		<p>outer diameter of the used needle in m</p>

<h2>3) Numerical thresholds/constants</h2>

		<p>Normally, OpenCapsule should run smoothly with it's default values.
		However, to achieve convergence of the fitting or shooting algorithms, it can be necessary 
		(in some rare cases) to adapt the numerics to your specific input data.
		If you dare/need to change some of the numerical constants, you should exactly know what you are doing and be 
		very careful, because values are tested/optimized intensively and small changes can dramatically change the 
		behaviour of the algorithms. </p>

	<b>EPS_RMS 1e-16 (1.0e-16 .. 1.0e-12)</b>
		<p>maximum arc-length deviation in bisection used to determine shortest distance 
		between contour points and shape.</p>
		
	<b>EPS_NEWTON_LAPLACE 1e-6, EPS_NEWTON_HOOKE 1e-6 (1.0e-8 .. 1.0e-3)</b>
		<p>newton minimization used for regression reference/elastic equations stops if 
		euclidian norm of parameter update falls below this threshold.</p>
		
	<b>EPS_SINGLE_SHOOTING 1e-6 (1.0e-8 .. 1.0e-4)</b>
		<p>shooting method used to solve elastic equations stops if deviation to boundary falls
		below this threshold. deviation of 0.01 corresponds to 1%. </p>
		
	<b>EPS_MULTI_SHOOTING 1e-6 (1.0e-8 .. 1.0e-4) </b>
		<p>shooting method used to improve single shooting stops if euclidian norm of residual
		falls below this threshold. residual aggregates all distance vectors between individual
		segments of solution.</p>
		
	<b>DX_FIT 1e-6 (1.0e-8 .. 1.0e-4) </b>
		<p>interval width used to determine numerical derivatives during regression, 
		i.e. change of shape with parameters (moduli, pressure, ..).</p>
		
	<b>DX_SHOOTING 1e-6 (1.0e-8 .. 1.0e-4) </b>
		<p>interval width used to determine numerical derivatives in multiple shooting method,
		i.e. change of segment end-points with initial values.</p>
		
	<b>INTEGRATION_STEP_LAPLACE 1e-4 (1.0e-4 .. 1.0e-3)</b>
		<p>step width of RK4 method to solve reference equations.</p>
		
	<b>INTEGRATION_STEP_HOOKE 1e-4 (1.0e-4 .. 1.0e-3)</b>
		<p>step width of RK4 method to solve elastic equations.</p>
		
	<b>EPS_IMPLICIT_RK 1e-10</b>
		<p>implicit RK4 integration used to solve elastic equations stops if euclidian norm 
		of slope update falls below this threshold</p>
		
	<b>IMPLICIT_INTEGRATION 0</b>
		<p>activate/deactivate implicit RK4 integration. 
		(obsolete, slow, introduced for testing of stability)</p>
		
	<b>EPS_NELDER_MEAD 1e-4</b>
		<p>nelder-mead (downhill simplex) method stops if error difference between worst and best
		vertex falls below this threshold.</p>
		
<h2>4) Image processing (user-space)</h2>

		<p>If your image processing fails, you might want to tune some of the following values.</p>

	<b>SCALE_IMAGE 1e-2</b>
		<p>extracted contour points from image are simply multiplied by this value to do
		some prescaling before fitting reference shapes.</p>
		
	<b>T_LOW 0.3, T_HIGH 0.6 (0.0 .. 1.0)</b>
		<p>lower and higher threshold of hysteresis algorithm performed as last step of edge detection.
    you can safely use higher values, OpenCapsule will automatically lower the thresholds if no closed contour is found.</p>
		
	<b>GAUSSIAN_SIGMA 1.0 (1.0 .. 10.0)</b>
		<p>width of gaussian smoothing image before edge detection.</p>
		
	<b>R_MIN 1, R_MAX 5 (1 .. 10)</b>
		<p>minimum and maximum radius of applied gaussian filters 
		(OpenCapsule averages over binary images resulting from smoothing with differently sized gaussians).</p>
		
	<b>THRESHOLD_CAPILLARY 5 (1 .. 20)</b>
		<p>used for tracing outer capillary from upper image border to inner capillary. 
		searching terminates if contour pixel deviates more than this threshold from 
		average horizontal position</p>
		
	<b>TOP_BUFFER 1 (0 .. 20)</b>
		<p>vertical distance from detected capillary height to nearest contour point
		(necessary because of possible surfactant/polymer sediments at the inner capillary)</p>
		
	<b>CHECK_IF_CLOSED 1</b>
		<p>activates/deactivate check for closed contour in binary image. 
		(keep activated if possible, deactivation will skip abortion if contour not closed, 
		behaviour will be undefined.)</p>
    
  <b>FIX_CHARACTERISTICS 1</b>
    <p>capillary position will be detected only from reference state, elastic states then use the same position.
    this option is useful if capsule shapes occur, which are parallel to the needle at the capsule mounting point.
    You can keep FIX_CHARACTERISTICS activated if you are sure that the camera or the needle does not move during
    the whole video.</p>

<h2>5) Functional switches/features (user-space)</h2>

		<p>These switches can be set to 1 (active) and 0 (inactive) and are used to control program flow.
		For example you can activate Nelder-Mead prefitting (recommended if you 
		can only roughly imagine your initial values for elastic moduli and pressure).
		If you have measured for example the pressure or know poisson's ratio you can switch of the regression
		of these specific parameters. Note that this is a constraint and will probably lead to higher fit errors.
		In case of only weakly deflated capsules you can deactivate EXTENDED_SHOOTING to improve speed of the algorithm.</p>

	<b>FIT_PRESSURE 1</b>
		<p>sets pressure as free parameter of the regression</p>

	<b>FIT_POISSON 1</b>
		<p>sets poisson ratio as free parameter of the regression</p>

	<b>FIT_COMPRESSION 1</b>
		<p>sets area compression modulus as free parameter of the regression</p>

	<b>EXTENDED_SHOOTING 1</b>
		<p>activates/deactivates multiple shooting method used to improve 
		solution of single shooting method</p>

	<b>FORCE_SYMMETRY 0 (experimental)</b> 
		<p>activates/deactivates rotation of contour points to align them to symmetry axis</p>

  <b>FORCE_BOUNDARY_SYMMETRY 1</b>
    <p>activates/deactivates symmetric aligning of two the contour points associated with capillary</p>

	<b>NELDERMEAD_PREFITTING 0</b>
		<p>activates/deactivates nelder-mead regression before newton regression</p>

  <b>PARAMETER_TRACING 1</b>
<p>actiates/deactivates use of fit result in next image as initial values.</p>

<b>WRINKLING_WAVELENGTH 0.0</b>
<p>specifies a manually measured wrinkle wavelength in units of pixels.</p>

<h2>6) General directories</h2>

	<b>INPUT_FOLDER ./input/</b>
		<p>specifies folder, from which images are read</p>

	<b>CONFIG_FOLDER ./config/</b>
		<p>specifies folder, in which configuration file is placed</p>

	<b>OUT_FOLDER ./out/</b>
		<p>specifies folder for miscellaneous output files</p>

	<b>GLOBAL_OUT_FOLDER ./global_out/ </b>
		<p>specifies folder for final output provided to user</p>

	<b>TMP_FOLDER ./tmp/</b>
		<p>specifies folder, in which automatically generated gnuplot scripts are placed</p>

<h2>7) Debugging:</h2>

		<p>These switches are very useful for debugging purposes. If something goes 
		seriously wrong, you should activate some of the following switches to see 
		what happens.</p>

	<b>WATCH_SINGLE_SHOOTING 0</b>
		<p>activates/deactivates stdout information of single shooting method</p>

	<b>WATCH_MULTI_SHOOTING 0</b>
		<p>activates/deactivates stdout information of multiple shooting method</p>

	<b>WATCH_LAPLACE_FITTING 1</b>
		<p>activates/deactivates stdout information of reference newton regression</p>

	<b>WATCH_HOOKE_FITTING 1</b>
		<p>activates/deactivates stdout information of elastic newton regression</p>

	<b>WATCH_QR_DECOMPOSITION 0</b>
		<p>activates/deactivates stdout information of QR-decomposition</p>

	<b>WATCH_NELDER_MEAD 1</b>
		<p>activates/deactivates stdout information of elastic nelder-mead regression</p>






</body>
</html> 
